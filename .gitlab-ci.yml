# ---- Pipeline MindfulSpace ----
stages: [verify, build, deploy]

# Variables globales
variables:
  # Évite l'échec de "prisma generate" en verify (pas de vraie DB en CI)
  DATABASE_URL: "postgresql://user:pass@localhost:5432/dummy?schema=public"
  # Utilisé par Kaniko pour le fichier d'auth docker
  DOCKER_CONFIG: /kaniko/.docker

# Paramètres par défaut des jobs
default:
  tags: [docker, linux]

# -------- VERIFY (toutes branches & MR) --------
verify:frontend:
  stage: verify
  image: node:20-alpine
  script:
    - corepack enable
    - pnpm -v || npm i -g pnpm
    - pnpm install --frozen-lockfile
    - pnpm --filter ./apps/frontend-next build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'

verify:api:
  stage: verify
  image: node:20-alpine
  script:
    - corepack enable
    - pnpm -v || npm i -g pnpm
    - pnpm install --frozen-lockfile
    - pnpm --filter ./apps/api-nest build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'

# -------- BUILD (main & tags) --------
.build_with_kaniko:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug   # contient /bin/sh
    entrypoint: [""]                             # ne pas écraser notre script
  before_script:
    - mkdir -p "$DOCKER_CONFIG"
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > "$DOCKER_CONFIG/config.json"

build:images:
  extends: .build_with_kaniko
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  script:
    - if [ -n "$CI_COMMIT_TAG" ]; then FRONT_TAG=prod; API_TAG=prod; else FRONT_TAG=staging; API_TAG=staging; fi
    # Frontend
    - >
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "apps/frontend-next/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/frontend:${FRONT_TAG}"
      --cache=true --cache-repo="${KANIKO_CACHE_REPO}"
    # API
    - >
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "apps/api-nest/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/api:${API_TAG}"
      --cache=true --cache-repo="${KANIKO_CACHE_REPO}"

# -------- DEPLOY (staging=main, prod=tag) --------
.deploy_base:
  image: alpine:3.20
  stage: deploy
  needs: ["build:images"]
  before_script:
    - apk add --no-cache openssh-client curl
    - mkdir -p ~/.ssh
    - echo "$SSH_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - printf "Host vps\n  HostName %s\n  Port %s\n  User %s\n  IdentityFile ~/.ssh/id_ed25519\n  StrictHostKeyChecking no\n" \
      "$SSH_HOST" "$SSH_PORT" "$SSH_USER" > ~/.ssh/config

deploy:staging:
  extends: .deploy_base
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - DEPLOY_DIR="$STAGING_DEPLOY_DIR"
    - URL="$STAGING_DATABASE_URL"

    # dossier de déploiement (déjà possédé par l'utilisateur deploy)
    - ssh vps "mkdir -p '$DEPLOY_DIR'"

    # api.env = DATABASE_URL complète
    - ssh vps "printf 'DATABASE_URL=%s\n' '$URL' | tee '$DEPLOY_DIR/api.env' >/dev/null && chmod 600 '$DEPLOY_DIR/api.env'"

    # db.env = password extrait depuis l’URL
    - |
      ssh vps '
        set -euo pipefail
        URL='"$URL"'
        CREDS=$(printf "%s" "$URL" | sed -E "s#^[a-zA-Z0-9+.-]+://([^@]+)@.*#\1#")
        PASS=${CREDS#*:}
        printf "POSTGRES_PASSWORD=%s\n" "$PASS" | tee "'"$DEPLOY_DIR"'/db.env" >/dev/null
        chmod 600 "'"$DEPLOY_DIR"'/db.env"
      '

    # docker compose (sans sudo, utilisateur deploy dans le groupe docker)
    - ssh vps "cd '$DEPLOY_DIR' && docker compose pull && docker compose up -d && docker compose ps"

    # migrations & seed Prisma
    #- ssh vps "cd '$DEPLOY_DIR' && docker compose exec -T api npx prisma migrate deploy"
    #- ssh vps "cd '$DEPLOY_DIR' && docker compose exec -T api npx prisma db seed || true"

    # checks HTTP
    - ssh vps "curl -sfI https://api.staging.mindfulspace.be/health >/dev/null"
    - ssh vps "curl -sfI https://staging.mindfulspace.be >/dev/null"

deploy:prod:
  extends: .deploy_base
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - DEPLOY_DIR="$PRODUCTION_DEPLOY_DIR"
    - URL="$PROD_DATABASE_URL"

    - ssh vps "mkdir -p '$DEPLOY_DIR'"

    - ssh vps "printf 'DATABASE_URL=%s\n' '$URL' | tee '$DEPLOY_DIR/api.env' >/dev/null && chmod 600 '$DEPLOY_DIR/api.env'"

    - |
      ssh vps '
        set -euo pipefail
        URL='"$URL"'
        CREDS=$(printf "%s" "$URL" | sed -E "s#^[a-zA-Z0-9+.-]+://([^@]+)@.*#\1#")
        PASS=${CREDS#*:}
        printf "POSTGRES_PASSWORD=%s\n" "$PASS" | tee "'"$DEPLOY_DIR"'/db.env" >/dev/null
        chmod 600 "'"$DEPLOY_DIR"'/db.env"
      '

    - ssh vps "cd '$DEPLOY_DIR' && docker compose pull && docker compose up -d && docker compose ps"

    - ssh vps "cd '$DEPLOY_DIR' && docker compose exec -T api npx prisma migrate deploy"

    - ssh vps "curl -sfI https://api.mindfulspace.be/health >/dev/null"
    - ssh vps "curl -sfI https://mindfulspace.be >/dev/null"
