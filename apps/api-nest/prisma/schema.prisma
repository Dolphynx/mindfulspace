generator client {
  provider = "prisma-client-js" // g√©n√®re le client TypeScript Prisma
}

datasource db {
  provider = "postgresql"       // base cible : PostgreSQL
  url      = env("DATABASE_URL") // cha√Æne de connexion inject√©e via l'env
}

enum MeditationMode {
  TIMER   // s√©ance minut√©e, sans m√©dia
  AUDIO   // lecture audio (fichiers mp3, etc.)
  VIDEO   // lecture vid√©o (YouTube, autres)
  VISUAL  // exercise purement visuel (animations, SVG, etc.)
}

enum MeditationSessionSource {
  GUIDED      // s√©ance guid√©e via un contenu (audio / visuel)
  MANUAL      // s√©ance encod√©e manuellement
  QUICK_TIMER // s√©ance cr√©√©e via un simple timer rapide
}

enum MeditationVisualType {
  BREATHING_WAVE // animation type vague de respiration
  LOTUS_OPENING  // lotus qui s‚Äôouvre / se ferme
  CIRCLE_PULSE   // cercle qui pulse au rythme de la respiration
}

// Donn√©es de test pour un graphique sur la home
model TestData {
  id          String   @id @default(uuid())
  metricName  String        // nom logique de la m√©trique
  label       String        // libell√© affich√© dans le graphique
  metricValue Int           // valeur num√©rique √† tracer
  createdAt   DateTime @default(now())
}

model SleepSession {
  id          String   @id @default(uuid())
  hours       Int           // nombre d'heures de sommeil
  quality     Int?          // √©valuation subjective (√©chelle simple)
  dateSession DateTime      // date r√©elle de la nuit
  dateCreated DateTime @default(now()) // date d‚Äôencodage en DB

  user   User?   @relation(fields: [userId], references: [id])
  userId String? // utilisateur propri√©taire (nullable pour tests)
}

model MeditationSession {
  id String @id @default(cuid())

  userId String                    // FK vers l'utilisateur
  user   User   @relation(fields: [userId], references: [id])

  // Origine de la s√©ance (wizard, manuel, quick timer‚Ä¶)
  source MeditationSessionSource

  // TYPE choisi par l'utilisateur
  meditationTypeId String
  meditationType   MeditationType @relation("SessionActualType", fields: [meditationTypeId], references: [id])

  // Contenu GUIDED (optionnel : TIMER simple n'en a pas)
  meditationContentId String?
  meditationContent   MeditationContent? @relation(fields: [meditationContentId], references: [id])

  startedAt       DateTime? // d√©but effectif de la s√©ance
  endedAt         DateTime? // fin effective de la s√©ance
  durationSeconds Int       // dur√©e stock√©e en secondes

  moodBefore Int? // humeur avant la s√©ance (1‚Äì5)
  moodAfter  Int? // humeur apr√®s la s√©ance (1‚Äì5)
  notes      String? // notes libres √©ventuelles

  createdAt DateTime @default(now())

  @@index([userId])              // requ√™tes filtr√©es par utilisateur
  @@index([meditationTypeId])    // analytics par type de m√©ditation
  @@index([meditationContentId]) // lien rapide vers le contenu utilis√©
  @@map("meditation_session")    // nom de table explicite en DB
}

model MeditationType {
  id        String  @id @default(cuid())
  slug      String  @unique         // identifiant stable pour i18n & front
  //name        String
  //description String?
  isActive  Boolean @default(true)  // permet de masquer un type sans le supprimer
  sortOrder Int?                    // ordre d‚Äôaffichage dans le catalogue

  contents MeditationContent[] @relation("ContentDefaultType") // contenus dont c‚Äôest le type par d√©faut
  sessions MeditationSession[] @relation("SessionActualType")  // s√©ances r√©ellement associ√©es √† ce type

  @@map("meditation_type")
}

model MeditationContent {
  id          String  @id @default(cuid())
  title       String        // titre visible c√¥t√© front
  description String?       // description courte du contenu

  // Mode : TIMER / AUDIO / VIDEO / VISUAL
  mode MeditationMode

  // Type par d√©faut pour les sessions lanc√©es par ce contenu
  defaultMeditationTypeId String
  defaultMeditationType   MeditationType @relation("ContentDefaultType", fields: [defaultMeditationTypeId], references: [id])

  // Dur√©es (suggestions / bornes) pour filtrage et UX
  defaultDurationSeconds Int? // dur√©e sugg√©r√©e par d√©faut
  minDurationSeconds     Int? // dur√©e minimale sens√©e pour ce contenu
  maxDurationSeconds     Int? // dur√©e maximale sens√©e pour ce contenu

  // Media unique (audio OU vid√©o), optionnel si TIMER/VISUAL
  mediaUrl String? // ex: "/audio/respiration.mp3" ou "https://youtu.be/..."

  isActive  Boolean @default(true)   // pour masquer un contenu sans le supprimer
  isPremium Boolean  @default(false) // restreint aux utilisateurs premium
  sortOrder Int?                     // tri dans les listes (wizard, catalogue)

  // Relations
  visualConfig MeditationVisualConfig? // config JSON sp√©cifique si VISUAL
  sessions     MeditationSession[]     // sessions GUIDED bas√©es sur ce contenu
  programItems MeditationProgramItem[] // utilis√© dans des programmes

  @@map("meditation_content")
}

model MeditationVisualConfig {
  id String @id @default(cuid())

  meditationContentId String            @unique // un visuel config par contenu
  meditationContent   MeditationContent @relation(fields: [meditationContentId], references: [id])

  visualType MeditationVisualType // type d'animation (lotus, vagues, etc.)

    /// Configuration s√©rialis√©e, adapt√©e au type de visuel.
    /// Pour le cercle qui "respire", on utilise par exemple :
    /// {
    ///   "totalCycles": 3,
    ///   "inhaleMs": 4000,
    ///   "holdFullMs": 4000,
    ///   "exhaleMs": 4000,
    ///   "holdEmptyMs": 0,
    ///   "minScale": 0.9,
    ///   "maxScale": 1.1
    /// }
  configJson Json // ex: { "breathIn": 5, "breathOut": 5, "cycles": 12 }

  @@map("meditation_visual_config")
}

/**
 * Programmes de m√©ditation (s√©quences de MeditationContent)
 */
model MeditationProgram {
  id          String  @id @default(cuid())
  title       String        // nom du programme (ex: "D√©buter la m√©ditation")
  description String?
  isActive    Boolean @default(true)  // permet de cacher un programme
  isPremium   Boolean @default(false) // programme r√©serv√© aux abonn√©s
  sortOrder   Int?                    // ordre d‚Äôaffichage dans les listes

  items     MeditationProgramItem[]
  resources Resource[] // ressources √©ditoriales qui pointent vers ce programme

  @@map("meditation_program")
}

model MeditationProgramItem {
  id                  String @id @default(cuid())
  meditationProgramId String // FK vers le programme
  meditationContentId String // FK vers le contenu de m√©ditation
  order               Int    // position dans la s√©quence (1, 2, 3‚Ä¶)

  meditationProgram MeditationProgram @relation(fields: [meditationProgramId], references: [id])
  meditationContent MeditationContent @relation(fields: [meditationContentId], references: [id])

  @@map("meditation_program_item")
}

model WorkoutSession {
  id          String   @id @default(uuid())
  quality     Int?          // √©valuation subjective de la s√©ance
  dateSession DateTime      // jour de l‚Äôentra√Ænement
  dateCreated DateTime @default(now())

  exerciceSessions ExerciceSession[] // exercices d√©taill√©s composant la s√©ance

  user   User?   @relation(fields: [userId], references: [id])
  userId String? // utilisateur propri√©taire
}

model ExerciceType {
  id          String         @id @default(uuid())
  name        String         @unique
  Description String

  exerciceSessions ExerciceSession[]
  steps            ExerciceStep[]   // üëà all the steps for this exercise type
}

model ExerciceStep {
  id             String        @id @default(uuid())
  exerciceTypeId String
  exerciceType   ExerciceType  @relation(fields: [exerciceTypeId], references: [id])

  order          Int           // step number: 1, 2, 3, ...
  title          String?       // optional, e.g. "Starting position"
  description    String        // explanation for this step
  imageUrl       String?       // URL of the image (e.g. S3, Cloudinary, /public, etc.)

  @@unique([exerciceTypeId, order]) // ensures you don‚Äôt have two ‚Äústep 1‚Äù for the same exercise
}


model ExerciceSession {
  workoutSessionId String // FK vers la s√©ance globale
  exerciceTypeId   String // FK vers le type d'exercise

  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id])
  exerciceType   ExerciceType   @relation(fields: [exerciceTypeId], references: [id])

  repetitionCount Int // nombre de r√©p√©titions / unit√©s pour cet exercise

  @@id([workoutSessionId, exerciceTypeId]) // cl√© composite (un type par s√©ance)
}

model User {
  id          String  @id @default(cuid())
  email       String  @unique
  displayName String?
  password    String? // Nullable for OAuth-only users

  emailVerified Boolean @default(false)
  isActive      Boolean @default(true) // For soft deletes / account suspension

  workoutSessions    WorkoutSession[]
  sleepSessions      SleepSession[]
  meditationSessions MeditationSession[]

  // Auth relations
  emailVerificationTokens EmailVerificationToken[]
  refreshTokens           RefreshToken[]
  passwordResetTokens     PasswordResetToken[]
  oauthAccounts           OAuthAccount[]
  userRoles               UserRole[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt     // mis √† jour automatiquement √† chaque write
}

// Email verification tokens
model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// Refresh tokens (stored in DB for security)
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Track device/session info for security
  userAgent String?
  ipAddress String?

  @@index([userId])
  @@index([token])
}

// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime? // Track if token was used

  @@index([userId])
  @@index([token])
}

// OAuth accounts (Google, GitHub, etc.)
model OAuthAccount {
  id           String @id @default(cuid())
  provider     String // "google", "github", etc.
  providerId   String // User ID from the OAuth provider
  userId       String
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
}

// Roles for RBAC
model Role {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "admin", "user", "coach", "premium"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]
}

// Join table for User-Role (many-to-many)
model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// Permissions for fine-grained access control
model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "sessions:create", "users:delete", "objectives:read"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
}

// Join table for Role-Permission (many-to-many)
model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

/**
 * model Objective { ... }
 */

enum ObjectiveFrequency {
  DAILY   // objectif journalier
  WEEKLY  // objectif hebdomadaire
  MONTHLY // objectif mensuel
}

enum ObjectiveDurationUnit {
  DAY   // unit√© jour
  WEEK  // unit√© semaine
  MONTH // unit√© mois
}

enum ResourceType {
  ARTICLE          // article texte long
  VIDEO            // ressource vid√©o
  MEDITATION_PROGRAM // lien vers un programme de m√©ditation
  WORKOUT_PROGRAM  // futur : programme d'entra√Ænement
  GUIDE            // guide / fiche pratique structur√©e
}

model ResourceCategory {
  id        String  @id @default(uuid())
  name      String        // nom de la cat√©gorie (ex: "Sommeil")
  slug      String  @unique // identifiant stable pour routing / filtres
  iconEmoji String? // petit pictogramme dans l‚ÄôUI (optionnel)

  resources Resource[]
}

model ResourceTag {
  id   String @id @default(uuid())
  name String        // libell√© lisible (ex: "Stress")
  slug String @unique // identifiant pour filtres / URL

  resources ResourceTagOnResource[]
}

model Resource {
  id          String       @id @default(uuid())
  title       String             // titre √©ditorial
  slug        String       @unique // slug pour URL
  summary     String             // r√©sum√© court (teaser)
  content     String             // contenu complet (markdown, HTML‚Ä¶)
  type        ResourceType       // type de ressource (article, vid√©o‚Ä¶)
  isPremium   Boolean      @default(false) // contenu premium ou non
  isFeatured  Boolean      @default(false) // mis en avant sur la home
  authorName  String?             // nom de l‚Äôauteur si pertinent
  readTimeMin Int?               // estimation du temps de lecture
  externalUrl String?            // lien externe √©ventuel (YouTube, blog‚Ä¶)

  categoryId String
  category   ResourceCategory @relation(fields: [categoryId], references: [id])

  // Lien optionnel vers un programme de m√©ditation
  meditationProgramId String?
  meditationProgram   MeditationProgram? @relation(fields: [meditationProgramId], references: [id])

  // (WorkoutProgram => √† mettre en place)
  tags ResourceTagOnResource[] // jonction N-N avec les tags

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title])   // recherche plein texte partielle sur le titre
  @@index([summary]) // idem pour le r√©sum√©
}

model ResourceTagOnResource {
  resourceId String
  tagId      String

  resource Resource    @relation(fields: [resourceId], references: [id])
  tag      ResourceTag @relation(fields: [tagId], references: [id])

  @@id([resourceId, tagId]) // table de jonction N-N (cl√© composite)
}
